// server.js - ะัะฝะพะฒะฝะพะน ัะตัะฒะตัะฝัะน ัะฐะนะป ะฟัะธะปะพะถะตะฝะธั Liv Bubble

// 1. ะะผะฟะพััั ะฝะตะพะฑัะพะดะธะผัั ะผะพะดัะปะตะน
require('dotenv').config(); // ะะฐะณััะถะฐะตั ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั ะธะท .env
const express = require('express');
const fs = require('fs').promises; // ะัะฟะพะปัะทัะตะผ ะฟัะพะผะธัะธัะธัะธัะพะฒะฐะฝะฝัั ะฒะตััะธั fs
const path = require('path');

// 2. ะะฝะธัะธะฐะปะธะทะฐัะธั ะฟัะธะปะพะถะตะฝะธั Express
const app = express();
const PORT = process.env.PORT || 8080;
const ADMIN_PASSWORD = process.env.ADMIN_PASSWORD;

// 3. Middleware
// Middleware ะดะปั ะฟะฐััะธะฝะณะฐ JSON ะฒ ัะตะปะต ะทะฐะฟัะพัะฐ (ะฝะฐะฟัะธะผะตั, ะดะปั POST-ะทะฐะฟัะพัะพะฒ)
app.use(express.json());

// --- ะะฐัััะพะนะบะฐ ะพะฑัะปัะถะธะฒะฐะฝะธั ััะฐัะธัะตัะบะธั ัะฐะนะปะพะฒ ---
// Middleware ะดะปั ะพะฑัะปัะถะธะฒะฐะฝะธั ััะฐัะธัะตัะบะธั ัะฐะนะปะพะฒ ะธะท ะฟะฐะฟะบะธ 'admin' ะฟะพ ะฟััะธ '/admin'
// ะญัะพ ะฟะพะทะฒะพะปะธั ะทะฐะณััะถะฐัั admin.css ะธ admin.js ะฟะพ ะฐะดัะตัะฐะผ /admin/admin.css ะธ /admin/admin.js
app.use('/admin', express.static(path.join(__dirname, 'admin')));

// Middleware ะดะปั ะพะฑัะปัะถะธะฒะฐะฝะธั ััะฐัะธัะตัะบะธั ัะฐะนะปะพะฒ ะธะท ะฟะฐะฟะบะธ 'admin-panel' ะฟะพ ะฟััะธ '/admin-panel'
// ะญัะพ ะฟะพะทะฒะพะปะธั ะทะฐะณััะถะฐัั index.html ะธ ะดััะณะธะต ัะฐะนะปั ะธะท admin-panel ะฟะพ ะฐะดัะตัะฐะผ /admin-panel/...
app.use('/admin-panel', express.static(path.join(__dirname, 'admin-panel')));

// Middleware ะดะปั ะพะฑัะปัะถะธะฒะฐะฝะธั ััะฐัะธัะตัะบะธั ัะฐะนะปะพะฒ ะธะท ะบะพัะฝั ะฟัะพะตะบัะฐ (ะดะปั index.html, style.css, script.js, tasks.json)
// ะัะตะดะฟะพะปะฐะณะฐะตััั, ััะพ ะพัะฝะพะฒะฝะพะน ัะฐะนั ะฝะฐัะพะดะธััั ะฒ ะบะพัะฝะต. ะัะปะธ ั ะฒะฐั ะตััั ะฟะฐะฟะบะฐ 'public', ะทะฐะผะตะฝะธัะต '.' ะฝะฐ 'public'.
app.use(express.static(path.join(__dirname))); // ะะปะธ path.join(__dirname, 'public') ะตัะปะธ ัะฐะนะปั ัะฐะผ

// 4. ะะฐัััััั API

// --- ะะฐััััั ะดะปั ะฟัะพะฒะตัะบะธ ะฟะฐัะพะปั (ะธัะฟะพะปัะทัะตััั ะฝะฐ ัััะฐะฝะธัะต ะฒัะพะดะฐ /admin) ---
app.post('/check-password', (req, res) => {
    const { password } = req.body;
    console.log(`ะะพะฟััะบะฐ ะฒัะพะดะฐ ั ะฟะฐัะพะปะตะผ: ${password}`); // ะะปั ะพัะปะฐะดะบะธ
    if (password === ADMIN_PASSWORD) {
        console.log('โ ะัะพะด ะฒ ะฐะดะผะธะฝ-ะฟะฐะฝะตะปั ัะฐะทัะตัะตะฝ');
        return res.json({ success: true, message: 'ะะฐัะพะปั ะฒะตัะฝัะน' });
    } else {
        console.log('โ ะัะพะด ะฒ ะฐะดะผะธะฝ-ะฟะฐะฝะตะปั ะทะฐะฟัะตัะตะฝ: ะฝะตะฒะตัะฝัะน ะฟะฐัะพะปั');
        return res.status(401).json({ success: false, message: 'ะะตะฒะตัะฝัะน ะฟะฐัะพะปั' });
    }
});

// --- ะะฐััััั ะดะปั ะฟะพะปััะตะฝะธั ะทะฐะดะฐะฝะธะน (ะธัะฟะพะปัะทัะตััั ะฒ ะฐะดะผะธะฝะบะต ะธ ะฝะฐ ะพัะฝะพะฒะฝะพะผ ัะฐะนัะต) ---
app.get('/tasks.json', async (req, res) => {
    try {
        // ะงะธัะฐะตะผ ัะฐะนะป tasks.json
        const data = await fs.readFile(path.join(__dirname, 'tasks.json'), 'utf8');
        // ะะฐััะธะผ JSON ะธ ะพัะฟัะฐะฒะปัะตะผ ะบะปะธะตะฝัั
        res.json(JSON.parse(data));
        console.log('โ ะะฐะดะฐะฝะธั ััะฟะตัะฝะพ ะพัะฟัะฐะฒะปะตะฝั ะบะปะธะตะฝัั');
    } catch (err) {
        console.error('โ ะัะธะฑะบะฐ ััะตะฝะธั ัะฐะนะปะฐ tasks.json:', err);
        // ะัะฟัะฐะฒะปัะตะผ ะฟัััะพะน ะผะฐััะธะฒ, ะตัะปะธ ัะฐะนะป ะฝะต ะฝะฐะนะดะตะฝ ะธะปะธ ะพัะธะฑะบะฐ
        res.status(500).json({ priority_tasks: [] });
    }
});

// --- ะะฐััััั ะดะปั ะดะพะฑะฐะฒะปะตะฝะธั ะฝะพะฒะพะณะพ ะฟัััะพะณะพ ะทะฐะดะฐะฝะธั (ัะตัะตะท ะฐะดะผะธะฝะบั) ---
// ะัะธะผะตัะฐะฝะธะต: ะญัะฐ ััะฝะบัะธะพะฝะฐะปัะฝะพััั ัะถะต ัะฐััะธัะฝะพ ัะตะฐะปะธะทะพะฒะฐะฝะฐ ะฒ admin.js ัะตัะตะท push ะฒ ะผะฐััะธะฒ.
// ะญัะพั ะผะฐััััั ะผะพะถะตั ะฑััั ะธะทะฑััะพัะฝัะผ, ะตัะปะธ admin.js ะฝะฐะฟััะผัั ะผะพะดะธัะธัะธััะตั ะผะฐััะธะฒ ะฒ ะฟะฐะผััะธ,
// ะฐ ัะพััะฐะฝะตะฝะธะต ะฟัะพะธััะพะดะธั ัะตัะตะท /save-tasks. ะััะฐะฒะปะตะฝ ะดะปั ัะพะฒะผะตััะธะผะพััะธ ะธะปะธ ะตัะปะธ ะฝัะถะฝะฐ ัะตัะฒะตัะฝะฐั ะปะพะณะธะบะฐ.
app.post('/add-task', (req, res) => {
    const { password } = req.body;
    console.log('ะะพะฟััะบะฐ ะดะพะฑะฐะฒะธัั ะทะฐะดะฐะฝะธะต ัะตัะตะท API /add-task');
    if (password !== ADMIN_PASSWORD) {
        console.log('โ ะัะบะฐะทะฐะฝะพ ะฒ ะดะพะฑะฐะฒะปะตะฝะธะธ ะทะฐะดะฐะฝะธั: ะฝะตะฒะตัะฝัะน ะฟะฐัะพะปั');
        return res.status(401).json({ success: false, message: 'ะะตะฒะตัะฝัะน ะฟะฐัะพะปั' });
    }
    // ะะพะณะธะบะฐ ะดะพะฑะฐะฒะปะตะฝะธั ะทะฐะดะฐะฝะธั ะฝะฐ ัะตัะฒะตัะต (ะตัะปะธ ะฑั ะพะฝะฐ ะฑัะปะฐ ะฝัะถะฝะฐ ะทะดะตัั)
    // ะะพ ะฒ ัะตะบััะตะน ัะตะฐะปะธะทะฐัะธะธ admin.js ััะพ ะดะตะปะฐะตั ะบะปะธะตะฝั
    res.json({ success: true, message: 'ะะฐะดะฐะฝะธะต ะดะพะฑะฐะฒะปะตะฝะพ! (ะฝะฐ ะบะปะธะตะฝัะต)' });
    console.log('โ ะะฐะดะฐะฝะธะต ะดะพะฑะฐะฒะปะตะฝะพ (API ะฒัะทะฒะฐะฝ, ะฝะพ ะปะพะณะธะบะฐ ะฝะฐ ะบะปะธะตะฝัะต)');
});

// --- ะะฐััััั ะดะปั ัะพััะฐะฝะตะฝะธั ะฒัะตั ะทะฐะดะฐะฝะธะน (ะธะท ะฐะดะผะธะฝะบะธ) ---
app.post('/save-tasks', async (req, res) => {
    const { password, priority_tasks } = req.body;
    console.log('ะะพะฟััะบะฐ ัะพััะฐะฝะธัั ะทะฐะดะฐะฝะธั ัะตัะตะท API /save-tasks');
    if (password !== ADMIN_PASSWORD) {
        console.log('โ ะัะบะฐะทะฐะฝะพ ะฒ ัะพััะฐะฝะตะฝะธะธ ะทะฐะดะฐะฝะธะน: ะฝะตะฒะตัะฝัะน ะฟะฐัะพะปั');
        return res.status(401).json({ success: false, message: 'ะะตะฒะตัะฝัะน ะฟะฐัะพะปั' });
    }
    try {
        // ะะฐะฟะธััะฒะฐะตะผ ะฟะพะปััะตะฝะฝัะต ะดะฐะฝะฝัะต ะฒ ัะฐะนะป tasks.json
        await fs.writeFile(path.join(__dirname, 'tasks.json'), JSON.stringify({ priority_tasks }, null, 2));
        console.log('โ ะะฐะดะฐะฝะธั ััะฟะตัะฝะพ ัะพััะฐะฝะตะฝั ะฒ ัะฐะนะป tasks.json');
        res.json({ success: true, message: 'ะะฐะดะฐะฝะธั ััะฟะตัะฝะพ ัะพััะฐะฝะตะฝั!' });
    } catch (err) {
        console.error('โ ะัะธะฑะบะฐ ัะพััะฐะฝะตะฝะธั ัะฐะนะปะฐ tasks.json:', err);
        res.status(500).json({ success: false, message: 'ะัะธะฑะบะฐ ัะพััะฐะฝะตะฝะธั ะฝะฐ ัะตัะฒะตัะต' });
    }
});

// 5. ะะฐัััััั ะดะปั ัััะฐะฝะธั (ััะพะฑั Express ะทะฝะฐะป, ะบะฐะบะธะต HTML-ัะฐะนะปั ะพัะดะฐะฒะฐัั)

// --- ะะฐััััั ะดะปั ะณะปะฐะฒะฝะพะน ัััะฐะฝะธัั ัะฐะนัะฐ ---
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'index.html')); // ะะปะธ path.join(__dirname, 'public', 'index.html')
    console.log('๐ ะัะฟัะฐะฒะปะตะฝะฐ ะณะปะฐะฒะฝะฐั ัััะฐะฝะธัะฐ index.html');
});

// --- ะะฐััััั ะดะปั ัััะฐะฝะธัั ะฒัะพะดะฐ ะฒ ะฐะดะผะธะฝะบั ---
app.get('/admin', (req, res) => {
    res.sendFile(path.join(__dirname, 'admin', 'index.html'));
    console.log('๐ ะัะฟัะฐะฒะปะตะฝะฐ ัััะฐะฝะธัะฐ ะฒัะพะดะฐ admin/index.html');
});

// --- ะะฐััััั ะดะปั ะฐะดะผะธะฝ-ะฟะฐะฝะตะปะธ ---
// ะะฑัะฐะฑะฐััะฒะฐะตั ะฟััะผะพะน ะฟะตัะตัะพะด ะฟะพ /admin-panel/ (ะฑะตะท index.html ะฒ URL)
app.get('/admin-panel', (req, res) => {
    res.sendFile(path.join(__dirname, 'admin-panel', 'index.html'));
    console.log('๐ฏ ะัะฟัะฐะฒะปะตะฝะฐ ะฐะดะผะธะฝ-ะฟะฐะฝะตะปั admin-panel/index.html');
});

// 6. ะะฐะฟััะบ ัะตัะฒะตัะฐ
app.listen(PORT, () => {
    console.log(`๐ ะกะตัะฒะตั ะทะฐะฟััะตะฝ ะธ ัะปััะฐะตั ะฟะพัั ${PORT}`);
    console.log(`๐ ะะพะบะฐะปัะฝัะน ะฐะดัะตั: http://localhost:${PORT}`);
});

